{% extends "base.html" %}
{% block content %}
<style>
    :root {
        --primary-color: #18191b;
        --success-color: #28a745;
        --bg-light: #f8f9fa;
        --bg-white: #ffffff;
        --text-dark: #343a40;
        --text-light: #6c757d;
        --border-color: #dee2e6;
        --shadow-color: rgba(0, 0, 0, 0.1);
    }

    .main-container {
        width: 100%;
        max-width: 1200px; /* Increased width for more columns */
        background-color: var(--bg-white);
        border-radius: 20px;
        box-shadow: 0 10px 30px var(--shadow-color);
        overflow: hidden;
        margin-top: 100px; /* Space for fixed header */
        margin-bottom: 40px;
    }

    .main-header-bar {
        position: relative;
        top: 20px;
        left: 51%;
        transform: translateX(-50%);
        background: #ecf0f3;
        box-shadow: 6px 6px 10px #d1d9e6, -6px -6px 10px #fff;
        padding: 0 20px;
        border-radius: 10px;
        display: flex;
        width: 95%;
        max-width: 1200px;
        justify-content: space-between;
        align-items: center;
        height: 70px;
        z-index: 100;
    }

    .main-header-bar h2 {
        color: #2d5a2f;
        font-size: 1.5rem;
    }
    
    .dash-link {
        text-decoration: none;
        padding: 10px 20px;
        color: white;
        background: linear-gradient(135deg, #FF7043, #D84315);
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    .dash-link:hover {
        transform: translateY(-2px);
    }

    .form-content {
        padding: 40px;
        background: #ecf0f3;
    }

    form {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Two main columns for layout */
        gap: 30px;
    }

    .form-column {
        background-color: var(--bg-light);
        padding: 20px;
        border-radius: 15px;
        box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .form-column h3 {
        font-size: 1.2rem;
        color: var(--text-dark);
        margin-bottom: 0;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--primary-color);
    }

    .form-group {
        position: relative;
        margin-bottom: 0; /* Removed margin as gap is used */
    }

    .form-group .icon {
        position: absolute;
        top: 50%;
        left: 15px;
        transform: translateY(-50%);
        color: var(--text-light);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 15px 12px 45px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-family: 'Poppins', sans-serif;
        color: var(--text-dark);
        background-color: var(--bg-white);
        transition: all 0.3s ease;
    }
    
    .form-group textarea { padding: 12px; } /* Textarea doesn't need icon padding */

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(58, 134, 215, 0.3);
    }
    
    .form-group input[readonly] {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    button[type="submit"] {
        grid-column: 1 / -1;
        width: 50%;
        margin: 20px auto 0;
        padding: 15px;
        font-weight: 800;
        background-color: hsl(170, 67%, 27%);
        box-shadow: 0.2rem 0.2rem 0.2rem hsl(170, 38%, 27%);
        border: none;
        border-radius: 5px;
        color: #ecf0f3;
        cursor: pointer;
    }

    /* Search Container from patient_visit */
    .search-container {
        grid-column: 1 / -1; /* Span full width */
        position: relative;
        margin-bottom: 10px;
    }
    .search-container label {
        font-weight: 600; color: #555; margin-bottom: 8px; display: block;
    }
    .search-container input {
        width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px;
    }
    #search_results {
        position: absolute;
        width: 100%;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        z-index: 10;
        max-height: 200px;
        overflow-y: auto;
    }
    .search-result-item { padding: 10px; cursor: pointer; }
    .search-result-item:hover { background-color: #f0f0f0; }
    
    #patient-context {
        grid-column: 1 / -1;
        background-color: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        display: none; /* Hidden by default */
    }

    /* Dynamic Laboratory Values styling */
    .add-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--primary-color);
    }
    .add-container h3 { border: none; padding: 0; }
    .add-icon-btn, .remove-icon-btn {
        background: none; border: none; font-size: 1.5rem; cursor: pointer;
    }
    .add-icon-btn { color: var(--primary-color); }
    .remove-icon-btn { color: #dc3545; }
    .add-more-container {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .add-more-container .form-group { flex: 1; }
    .add-more-container .form-group input { padding: 12px 15px; } /* No icon padding */

    /* Treatment history box */
    .history-box {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        max-height: 200px;
        overflow-y: auto;
    }
    .visit-entry {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

</style>

<header class="main-header-bar">
    <h2><i class="fas fa-file-medical"></i> Patient Visit & Registration</h2>
    <a href="{{ url_for('dashboard') }}" class="dash-link"><i class="fas fa-arrow-left"></i> Dashboard</a>
</header>

<div class="main-container">
    <div class="form-content">
        <form method="POST" action="{{ url_for('patient_visit') }}" id="patient_form" autocomplete="off">
            <input type="hidden" name="patient_id" id="patient_id">

            <div class="search-container">
                <label for="patient_search">Search Existing Patient (for Follow-up) or Register New</label>
                <input type="text" id="patient_search" placeholder="Start typing name or code...">
                <div id="search_results"></div>
            </div>
            
            <div id="patient-context">
                <p>
                    Adding follow-up for <strong><span id="context-patient-name"></span></strong>. 
                    This will be Visit #<span id="context-visit-number" style="font-weight: bold;"></span>.
                    <a href="#" id="clear-selection" style="margin-left: 10px;">Clear selection to register a new patient.</a>
                </p>
            </div>
            
            <div class="form-column">
                <h3><i class="fas fa-user-circle"></i> Patient Information</h3>
                <div class="form-group">
                    <input type="text" id="name" name="name" required placeholder="Full Name">
                    <i class="icon fas fa-user"></i>
                </div>
                <div class="form-group">
                    <input type="number" id="age" name="age" required placeholder="Age">
                    <i class="icon fas fa-birthday-cake"></i>
                </div>
                <div class="form-group">
                    <select id="gender" name="gender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                    <i class="icon fas fa-venus-mars"></i>
                </div>
                <div class="form-group">
                    <input type="tel" id="mobile_number" name="mobile_number" placeholder="Mobile Number">
                    <i class="icon fas fa-phone"></i>
                </div>
                <div class="form-group">
                    <input type="email" id="email" name="email" placeholder="Email Address">
                    <i class="icon fas fa-envelope"></i>
                </div>

                <h3><i class="fas fa-heartbeat"></i> Vital Signs</h3>
                <div class="form-group">
                    <input type="number" step="0.1" id="height" name="height" placeholder="Height (cm)">
                    <i class="icon fas fa-ruler-vertical"></i>
                </div>
                <div class="form-group">
                    <input type="number" step="0.1" id="weight" name="weight" placeholder="Weight (kg)">
                    <i class="icon fas fa-weight"></i>
                </div>
                 <div class="form-group">
                    <input type="text" id="blood_pressure" name="blood_pressure" placeholder="Blood Pressure (e.g., 120/80)">
                    <i class="icon fas fa-tint"></i>
                </div>
                <div class="form-group">
                    <input type="number" id="pulse_rate" name="pulse_rate" placeholder="Pulse Rate (bpm)">
                    <i class="icon fas fa-tachometer-alt"></i>
                </div>
                <div class="form-group">
                    <input type="number" step="0.1" id="temperature" name="temperature" placeholder="Temperature (Â°C)">
                    <i class="icon fas fa-thermometer-half"></i>
                </div>
                <div class="form-group">
                    <input type="number" name="blood_sugar" placeholder="Blood Sugar (mg/dL)">
                    <i class="icon fas fa-cookie-bite"></i>
                </div>
                <div class="form-group">
                    <input type="text" id="bmi" name="bmi" readonly placeholder="Calculated BMI">
                    <i class="icon fas fa-calculator"></i>
                </div>
                <div class="form-group">
                    <input type="text" id="bsa" name="bsa" readonly placeholder="Calculated BSA">
                    <i class="icon fas fa-calculator"></i>
                </div>
            </div>

            <div class="form-column">
                <h3><i class="fas fa-user-doctor"></i> Clinical Details</h3>
                <div class="form-group" id="treatment-history-container" style="display: none;">
                    <label><strong>Treatment History</strong></label>
                    <div id="treatment-history-content" class="history-box"><p>Select a patient to see history.</p></div>
                </div>
                <div class="form-group">
                    <textarea id="complaints" name="complaints" rows="3" placeholder="Current Complaints"></textarea>
                </div>
                <div class="form-group">
                    <textarea id="examination_findings" name="examination_findings" rows="4" placeholder="Current Examination Findings"></textarea>
                </div>
                <div class="form-group">
                    <textarea id="diagnosis" name="diagnosis" rows="2" placeholder="Current Diagnosis"></textarea>
                </div>
                <div class="form-group">
                    <textarea id="updated_treatment_plan" name="updated_treatment_plan" rows="4" placeholder="New/Updated Treatment Plan"></textarea>
                </div>
                <div class="form-group">
                    <input type="number" step="0.1" id="affected_bsa_percentage" name="affected_bsa_percentage" placeholder="Affected BSA (%)">
                     <i class="icon fas fa-percentage"></i>
                </div>

                <div class="add-container">
                    <h3><i class="fas fa-vial"></i> Laboratory Values</h3>
                    <button type="button" id="add-more-btn" class="add-icon-btn"><i class="fas fa-plus-circle"></i></button>
                </div>
                <div id="additional-vitals-container"></div>
            </div>

            <button type="submit"><i class="fas fa-save"></i> Save Visit / Register Patient</button>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // --- ELEMENT SELECTORS ---
    const form = document.getElementById('patient_form');
    const searchInput = document.getElementById('patient_search');
    const resultsDiv = document.getElementById('search_results');
    const patientContext = document.getElementById('patient-context');
    const contextName = document.getElementById('context-patient-name');
    const contextVisitNumber = document.getElementById('context-visit-number');
    const clearLink = document.getElementById('clear-selection');
    const historyContainer = document.getElementById('treatment-history-container');
    const historyContent = document.getElementById('treatment-history-content');
    
    // Vitals Inputs
    const heightInput = document.getElementById('height');
    const weightInput = document.getElementById('weight');
    const bmiInput = document.getElementById('bmi');
    const bsaInput = document.getElementById('bsa');

    // --- CORE FUNCTIONS ---
    function calculateMetrics() {
        const weight = parseFloat(weightInput.value);
        const height = parseFloat(heightInput.value);
        bmiInput.value = (weight > 0 && height > 0) ? (weight / ((height / 100) ** 2)).toFixed(2) : '';
        bsaInput.value = (weight > 0 && height > 0) ? Math.sqrt((height * weight) / 3600).toFixed(2) : '';
    }
    
    function resetFormToNewPatient() {
        form.reset();
        form.patient_id.value = '';
        patientContext.style.display = 'none';
        historyContainer.style.display = 'none';
        ['name', 'age', 'gender', 'mobile_number', 'email'].forEach(name => form[name].readOnly = false);
        calculateMetrics();
    }

    function displayTreatmentHistory(history) {
        historyContent.innerHTML = '';
        if (!history.initial_visit && history.follow_ups.length === 0) {
            historyContent.innerHTML = '<p>No past history found.</p>';
            return;
        }
        if (history.initial_visit) {
            const iv = history.initial_visit;
            const visitDate = new Date(iv.date_of_registration).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric'});
            historyContent.innerHTML += `<div class="visit-entry"><h5>Initial Visit (${visitDate})</h5><p><b>Diagnosis:</b> ${iv.diagnosis || 'N/A'}</p><p><b>Treatment:</b> ${iv.initial_treatment_plan || 'N/A'}</p></div>`;
        }
        history.follow_ups.forEach(visit => {
            const visitDate = new Date(visit.visit_date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric'});
            historyContent.innerHTML += `<div class="visit-entry"><h5>Follow-up (${visitDate})</h5><p><b>Diagnosis:</b> ${visit.diagnosis || 'N/A'}</p><p><b>Treatment:</b> ${visit.updated_treatment_plan || 'N/A'}</p></div>`;
        });
    }

    async function selectPatient(patient) {
        form.patient_id.value = patient.id;
        ['name', 'age', 'gender', 'mobile_number', 'email'].forEach(name => {
            form[name].value = patient[name] || '';
            form[name].readOnly = true;
        });
        form.height.value = patient.initial_height || '';
        form.weight.value = patient.initial_weight || '';
        calculateMetrics();
        ['complaints', 'examination_findings', 'diagnosis', 'updated_treatment_plan'].forEach(name => form[name].value = '');
        
        contextName.textContent = `${patient.patient_code} - ${patient.name}`;
        contextVisitNumber.textContent = patient.visit_count + 1;
        patientContext.style.display = 'block';
        searchInput.value = '';
        resultsDiv.innerHTML = '';
        resultsDiv.style.display = 'none';
        
        historyContainer.style.display = 'block';
        historyContent.innerHTML = '<p>Loading history...</p>';
        const response = await fetch(`/api/patient_history/${patient.id}`);
        const historyData = await response.json();
        displayTreatmentHistory(historyData);
    }

    // --- EVENT LISTENERS ---
    heightInput.addEventListener('input', calculateMetrics);
    weightInput.addEventListener('input', calculateMetrics);
    clearLink.addEventListener('click', (e) => { e.preventDefault(); resetFormToNewPatient(); });
    
    searchInput.addEventListener('input', async function() {
        const query = this.value;
        if (query.length < 2) {
            resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; return;
        }
        const response = await fetch(`/api/search_patients?q=${query}`);
        const patients = await response.json();
        resultsDiv.innerHTML = '';
        if (patients.length > 0) {
            patients.forEach(patient => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = `${patient.patient_code} - ${patient.name}`;
                item.onclick = () => selectPatient(patient);
                resultsDiv.appendChild(item);
            });
            resultsDiv.style.display = 'block';
        } else {
            resultsDiv.innerHTML = '<div class="search-result-item">No patients found.</div>';
            resultsDiv.style.display = 'block';
        }
    });

    // Dynamic Laboratory Values Logic
    const addMoreBtn = document.getElementById('add-more-btn');
    const container = document.getElementById('additional-vitals-container');
    let fieldCount = 0;
    addMoreBtn.addEventListener('click', function() {
        fieldCount++;
        const newRow = document.createElement('div');
        newRow.className = 'add-more-container';
        newRow.innerHTML = `
            <div class="form-group">
                <input type="text" name="vital_name_${fieldCount}" placeholder="Parameter Name" required>
            </div>
            <div class="form-group">
                <input type="text" name="vital_value_${fieldCount}" placeholder="Value" required>
            </div>
            <button type="button" class="remove-icon-btn"><i class="fas fa-times-circle"></i></button>
        `;
        container.appendChild(newRow);
        newRow.querySelector('.remove-icon-btn').addEventListener('click', () => newRow.remove());
    });

    // --- INITIAL STATE ---
    resetFormToNewPatient();
});
</script>
{% endblock %}