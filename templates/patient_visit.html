{% extends "base.html" %}
{% block content %}
<div class="form-container">
    <h1>Patient Follow-up Visit</h1>
    <form method="POST" action="{{ url_for('patient_visit') }}">
        <div class="search-container">
            <label for="patient_search">Search Existing Patient</label>
            <input type="text" id="patient_search" placeholder="Start typing name or code...">
            <div id="search_results"></div>
        </div>
        
        <input type="hidden" name="patient_id" id="patient_id">
        
        <div id="patient-context" style="display: none;">
            <p>
                Adding follow-up for <strong><span id="context-patient-name"></span></strong>. 
                Visit #<span id="context-visit-number" style="font-weight: bold;"></span>.
            </p>
        </div>

        <h3>Clinical Details</h3>
        <div class="form-group">
            <textarea id="complaints" name="complaints" rows="3" placeholder="Current Complaints"></textarea>
        </div>
        <div class="form-group">
            <textarea id="examination_findings" name="examination_findings" rows="4" placeholder="Current Examination Findings"></textarea>
        </div>
        <div class="form-group">
            <textarea id="diagnosis" name="diagnosis" rows="2" placeholder="Current Diagnosis"></textarea>
        </div>
        <div class="form-group">
            <textarea id="updated_treatment_plan" name="updated_treatment_plan" rows="4" placeholder="New/Updated Treatment Plan"></textarea>
        </div>

        <button type="submit" class="btn-submit">Save Visit</button>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById('patient_search');
    const resultsDiv = document.getElementById('search_results');
    const patientContext = document.getElementById('patient-context');
    const contextName = document.getElementById('context-patient-name');
    const contextVisitNumber = document.getElementById('context-visit-number');
    const patientIdInput = document.getElementById('patient_id');

    async function selectPatient(patient) {
        patientIdInput.value = patient.id;
        contextName.textContent = `${patient.patient_code} - ${patient.name}`;
        contextVisitNumber.textContent = patient.visit_count + 1;
        patientContext.style.display = 'block';
        searchInput.value = `${patient.patient_code} - ${patient.name}`;
        resultsDiv.innerHTML = '';
        resultsDiv.style.display = 'none';
    }

    searchInput.addEventListener('input', async function() {
        const query = this.value;
        if (query.length < 2) {
            resultsDiv.innerHTML = ''; 
            resultsDiv.style.display = 'none'; 
            return;
        }
        const response = await fetch(`/api/search_patients?q=${query}`);
        const patients = await response.json();
        resultsDiv.innerHTML = '';
        if (patients.length > 0) {
            patients.forEach(patient => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = `${patient.patient_code} - ${patient.name}`;
                item.onclick = () => selectPatient(patient);
                resultsDiv.appendChild(item);
            });
            resultsDiv.style.display = 'block';
        } else {
            resultsDiv.innerHTML = '<div class="search-result-item">No patients found.</div>';
            resultsDiv.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
